name: Validate PR

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Fetch main branch
        run: |
          git fetch origin main:main

      # --------------------------------------------------
      # 1) Check manifest.json NOT changed
      # --------------------------------------------------
      - name: Check manifest.json not changed
        run: |
          echo "ğŸ” Checking if manifest.json was modified..."
          
          if git diff --name-only main...HEAD | grep -q "custom_components/trv_regulator/manifest.json"; then
            echo ""
            echo "âŒ ERROR: manifest.json was changed in this PR!"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“– RULE: Copilot agent MUST NOT change manifest.json"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "ğŸ“š See: .github/COPILOT_CHANGELOG_RULES.md"
            echo "ğŸ“š See: PROMPT.md - section 'ğŸš« Co Copilot agent NESMÃ mÄ›nit'"
            echo ""
            echo "â„¹ï¸  Version bump happens AUTOMATICALLY via workflow."
            echo "â„¹ï¸  The bump-version.yaml workflow will:"
            echo "   1. Calculate new version from PR labels"
            echo "   2. Update manifest.json automatically"
            echo "   3. Create git tag and GitHub release"
            echo ""
            echo "ğŸ”§ To fix this PR:"
            echo "   1. Revert changes to manifest.json"
            echo "   2. Keep only your code changes"
            echo "   3. Push the corrected version"
            echo ""
            exit 1
          fi
          
          echo "âœ… manifest.json not changed - OK"

      # --------------------------------------------------
      # 2) Check CHANGELOG.md format
      # --------------------------------------------------
      - name: Check CHANGELOG format
        run: |
          echo "ğŸ” Checking CHANGELOG.md format..."
          
          # Check if new version section was added (e.g., ## [3.0.25])
          if git diff main...HEAD -- CHANGELOG.md | grep -E "^\+## \[[0-9]+\.[0-9]+\.[0-9]+\]"; then
            echo ""
            echo "âŒ ERROR: New version section added to CHANGELOG.md!"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“– RULE: ONLY update [Unreleased] section"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "ğŸ“š See: .github/COPILOT_CHANGELOG_RULES.md"
            echo ""
            echo "âœ… Correct format:"
            echo "   ## [Unreleased]"
            echo "   "
            echo "   ### PÅ™idÃ¡no"
            echo "   - Your new feature"
            echo ""
            echo "âŒ Incorrect (DO NOT add new version):"
            echo "   ## [3.0.25] - 2026-02-06"
            echo ""
            echo "â„¹ï¸  The workflow will automatically:"
            echo "   1. Move [Unreleased] content to new version"
            echo "   2. Add timestamp"
            echo "   3. Create empty [Unreleased] section"
            echo ""
            echo "ğŸ”§ To fix this PR:"
            echo "   1. Remove the ## [X.Y.Z] - DATE line"
            echo "   2. Keep your changes under ## [Unreleased]"
            echo "   3. Push the corrected version"
            echo ""
            exit 1
          fi
          
          # Check if [Unreleased] section exists
          if git diff main...HEAD -- CHANGELOG.md | grep -q "^+"; then
            if ! grep -q "## \[Unreleased\]" CHANGELOG.md; then
              echo ""
              echo "âš ï¸  WARNING: CHANGELOG.md changed but [Unreleased] section not found"
              echo ""
              echo "Make sure you have ## [Unreleased] section at the top."
              echo ""
            fi
          fi
          
          echo "âœ… CHANGELOG.md format OK"

      # --------------------------------------------------
      # 3) Check workflow files (warning only)
      # --------------------------------------------------
      - name: Check workflow files
        run: |
          echo "ğŸ” Checking workflow files..."
          
          if git diff --name-only main...HEAD | grep -q "^\.github/workflows/"; then
            echo ""
            echo "âš ï¸  WARNING: Workflow files were changed in this PR"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Changed workflow files:"
            git diff --name-only main...HEAD | grep "^\.github/workflows/" | sed 's/^/  - /'
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "âš ï¸  Make sure this was EXPLICITLY requested by the user."
            echo ""
            echo "ğŸ“š See: PROMPT.md - section 'ğŸš« Co Copilot agent NESMÃ mÄ›nit'"
            echo ""
            echo "This is just a warning - PR can still be merged if intended."
            echo ""
          else
            echo "âœ… No workflow files changed"
          fi

      # --------------------------------------------------
      # 4) Summary
      # --------------------------------------------------
      - name: Validation summary
        if: success()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… All validations passed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "This PR follows Copilot guidelines:"
          echo "  âœ… manifest.json not changed"
          echo "  âœ… CHANGELOG.md format correct"
          echo "  âœ… Ready for review"
          echo ""
