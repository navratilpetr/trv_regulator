name: Bump Version

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  bump-version:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # --------------------------------------------------
      # 1) Detekce scope zmen (infrastructure vs integration)
      # --------------------------------------------------
      - name: Check if integration code changed
        id: scope
        run: |
          # Z√≠skat zmƒõnƒõn√© soubory v PR
          FILES=$(git diff --name-only HEAD^ HEAD)

          # Pokud ≈æ√°dn√© soubory nebyly zmƒõnƒõny, p≈ôeskoƒç
          if [ -z "$FILES" ]; then
            echo "‚è≠Ô∏è No files changed - SKIP version bump"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Cesty kter√© NEVY≈ΩADUJ√ç version bump:
          INFRA_PATTERNS=(
            "^\.github/"          # CI/CD workflows
            "^\.copilot/"         # Copilot config
            "^examples/"          # P≈ô√≠klady Lovelace
            "README\.md$"         # README zmƒõny
            "PROMPT\.md$"         # PROMPT zmƒõny
            "\.editorconfig$"     # Editor config
            "\.gitignore$"        # Git ignore
            "CHANGELOG\.md$"      # CHANGELOG (auto-upravuje se)
          )

          # Zkontroluj jestli V≈†ECHNY zmƒõnƒõn√© soubory jsou infrastructure
          INTEGRATION_CHANGED=false

          while IFS= read -r file; do
            is_infra=false

            for pattern in "${INFRA_PATTERNS[@]}"; do
              if echo "$file" | grep -qE "$pattern"; then
                is_infra=true
                break
              fi
            done

            # Pokud soubor NEN√ç infrastructure ‚Üí integration zmƒõna
            if [ "$is_infra" = false ]; then
              INTEGRATION_CHANGED=true
              echo "üì¶ Integration file changed: $file"
              break
            fi
          done <<< "$FILES"

          if [ "$INTEGRATION_CHANGED" = false ]; then
            echo "‚è≠Ô∏è Only infrastructure files changed - SKIP version bump"
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "üì¶ Integration code changed - CONTINUE with version bump"
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      # --------------------------------------------------
      # 2) Kontrola manualni zmeny verze (Copilot agent)
      # --------------------------------------------------
      - name: Check manual version change
        if: steps.scope.outputs.skip == 'false'
        id: version_check
        run: |
          # Detekovat manu√°ln√≠ zmƒõnu verze (Copilot agent)
          if git diff --name-only HEAD^ HEAD | grep -q "manifest.json"; then
            echo "‚ö†Ô∏è manifest.json changed in PR - using manual version"
            MANUAL_VERSION=$(jq -r '.version' custom_components/trv_regulator/manifest.json)
            echo "manual_version=$MANUAL_VERSION" >> "$GITHUB_OUTPUT"
            echo "version_source=manual" >> "$GITHUB_OUTPUT"
            echo "‚úÖ Manual version detected: $MANUAL_VERSION"
          else
            echo "version_source=auto" >> "$GITHUB_OUTPUT"
            echo "‚úÖ Will auto-calculate version from labels"
          fi

      # --------------------------------------------------
      # 3) Urceni typu bumpu z labels
      # --------------------------------------------------
      - name: Determine version bump
        if: steps.scope.outputs.skip == 'false'
        id: bump
        run: |
          LABELS="${{ join(github.event.pull_request.labels.*.name, ',') }}"

          if echo "$LABELS" | grep -q "breaking"; then
            TYPE="major"
          elif echo "$LABELS" | grep -q "feature"; then
            TYPE="minor"
          else
            TYPE="patch"
          fi

          echo "type=$TYPE" >> "$GITHUB_OUTPUT"

      # --------------------------------------------------
      # 4) Nacteni aktualni verze
      # --------------------------------------------------
      - name: Read current version
        if: steps.scope.outputs.skip == 'false' && steps.version_check.outputs.version_source == 'auto'
        id: current
        run: |
          VERSION=$(jq -r '.version' custom_components/trv_regulator/manifest.json)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      # --------------------------------------------------
      # 5) Vypocet nove verze
      # --------------------------------------------------
      - name: Calculate new version
        if: steps.scope.outputs.skip == 'false'
        id: new
        run: |
          if [ "${{ steps.version_check.outputs.version_source }}" = "manual" ]; then
            # Pou≈æ√≠t manu√°ln√≠ verzi z PR
            NEW_VERSION="${{ steps.version_check.outputs.manual_version }}"
            echo "version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
            echo "‚úÖ Using manual version: $NEW_VERSION"
          else
            # Spoƒç√≠tat novou verzi podle labels
            CURRENT="${{ steps.current.outputs.version }}"
            TYPE="${{ steps.bump.outputs.type }}"

            IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

            case "$TYPE" in
              major)
                MAJOR=$((MAJOR + 1))
                MINOR=0
                PATCH=0
                ;;
              minor)
                MINOR=$((MINOR + 1))
                PATCH=0
                ;;
              patch)
                PATCH=$((PATCH + 1))
                ;;
            esac

            NEW_VERSION="$MAJOR.$MINOR.$PATCH"
            echo "version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
            echo "‚úÖ Auto-calculated version: $NEW_VERSION (type: $TYPE)"
          fi

      # --------------------------------------------------
      # 6) Update manifest.json bezpecne pres jq
      # --------------------------------------------------
      - name: Update manifest.json
        if: steps.scope.outputs.skip == 'false' && steps.version_check.outputs.version_source == 'auto'
        run: |
          jq '.version = "${{ steps.new.outputs.version }}"' \
            custom_components/trv_regulator/manifest.json > tmp.json

          mv tmp.json custom_components/trv_regulator/manifest.json
          echo "‚úÖ Updated manifest.json to ${{ steps.new.outputs.version }}"

      # --------------------------------------------------
      # 7) Update CHANGELOG
      # --------------------------------------------------
      - name: Update CHANGELOG
        if: steps.scope.outputs.skip == 'false'
        run: |
          DATETIME=$(date +"%Y-%m-%d %H:%M")
          VERSION="${{ steps.new.outputs.version }}"

          # Kontrola, ≈æe existuje [Unreleased]
          if ! grep -q "## \[Unreleased\]" CHANGELOG.md; then
            echo "‚ùå CHANGELOG.md neobsahuje sekci [Unreleased]!"
            exit 1
          fi

          # Kontrola, ≈æe verze U≈Ω TAM NEN√ç
          if grep -q "## \[$VERSION\]" CHANGELOG.md; then
            echo "‚ö†Ô∏è Verze [$VERSION] ji≈æ v CHANGELOG.md existuje!"
            echo "P≈ôeskakuji update CHANGELOG (pravdƒõpodobnƒõ duplicitn√≠ run)."
            # Neexituj s chybou, jen p≈ôeskoƒç
          else
            # Bezpeƒçn√° n√°hrada - jen PRVN√ç v√Ωskyt na ZAƒå√ÅTKU ≈ô√°dku
            # Pou≈æij awk m√≠sto sed pro vƒõt≈°√≠ kontrolu
            awk -v ver="$VERSION" -v dt="$DATETIME" '
              !done && /^## \[Unreleased\]/ {
                print "## [Unreleased]"
                print ""
                print "## [" ver "] - " dt
                done=1
                next
              }
              { print }
            ' CHANGELOG.md > CHANGELOG.tmp

            mv CHANGELOG.tmp CHANGELOG.md
            echo "‚úÖ CHANGELOG aktualizov√°n: [Unreleased] ‚Üí [$VERSION]"
          fi

      # --------------------------------------------------
      # 8) Urci prerelease logiku
      # --------------------------------------------------
      - name: Determine prerelease
        if: steps.scope.outputs.skip == 'false'
        id: pre
        run: |
          if [ "${{ steps.bump.outputs.type }}" = "patch" ]; then
            echo "pre=false" >> "$GITHUB_OUTPUT"
          else
            echo "pre=true" >> "$GITHUB_OUTPUT"
          fi

      # --------------------------------------------------
      # 9) Commit a tag
      # --------------------------------------------------
      - name: Commit and tag
        if: steps.scope.outputs.skip == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add custom_components/trv_regulator/manifest.json CHANGELOG.md

          git commit -m "chore: bump version to ${{ steps.new.outputs.version }}"

          # Smazat tag pokud u≈æ existuje (lok√°lnƒõ i na remote)
          if git rev-parse "v${{ steps.new.outputs.version }}" >/dev/null 2>&1; then
            echo "‚ö†Ô∏è Tag v${{ steps.new.outputs. version }} u≈æ existuje, ma≈æu..."
            git tag -d "v${{ steps.new.outputs.version }}"
            git push --delete origin "v${{ steps.new.outputs.version }}" 2>/dev/null || true
          fi

          git tag "v${{ steps.new.outputs.version }}"

          # ochrana proti race condition
          git pull --rebase origin main

          git push origin main --tags

      # --------------------------------------------------
      # 10) Vytvoreni release
      # --------------------------------------------------
      - name: Create GitHub Release
        if: steps.scope.outputs.skip == 'false'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.new.outputs.version }}
          release_name: Release v${{ steps.new.outputs.version }}
          body: |
            ## Zmƒõny z PR

            ${{ github.event.pull_request.title }}

            **PR:** ${{ github.event.pull_request.html_url }}

            ---
            Automaticky vygenerov√°no.
          draft: false
          prerelease: ${{ steps.pre.outputs.pre }}
