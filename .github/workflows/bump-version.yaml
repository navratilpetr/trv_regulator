name: Bump Version

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  bump-version:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # --------------------------------------------------
      # 1) Kontrola, ze v PR nebyla rucne zmenena verze
      # --------------------------------------------------
      - name: Check manual version change
        run: |
          if git diff --name-only HEAD^ HEAD | grep -q "manifest.json"; then
            echo "❌ V PR NESMIS menit verzi v manifest.json rucne!"
            echo "Pouzij labels: feature / breaking / nebo zadny (patch)."
            exit 1
          fi

      # --------------------------------------------------
      # 2) Urceni typu bumpu z labels
      # --------------------------------------------------
      - name: Determine version bump
        id: bump
        run: |
          LABELS="${{ join(github.event.pull_request.labels.*.name, ',') }}"

          if echo "$LABELS" | grep -q "breaking"; then
            TYPE="major"
          elif echo "$LABELS" | grep -q "feature"; then
            TYPE="minor"
          else
            TYPE="patch"
          fi

          echo "type=$TYPE" >> "$GITHUB_OUTPUT"

      # --------------------------------------------------
      # 3) Nacteni aktualni verze
      # --------------------------------------------------
      - name: Read current version
        id: current
        run: |
          VERSION=$(jq -r '.version' custom_components/trv_regulator/manifest.json)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      # --------------------------------------------------
      # 4) Vypocet nove verze
      # --------------------------------------------------
      - name: Calculate new version
        id: new
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          TYPE="${{ steps.bump.outputs.type }}"

          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          case "$TYPE" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "version=$NEW_VERSION" >> "$GITHUB_OUTPUT"

      # --------------------------------------------------
      # 5) Update manifest.json bezpecne pres jq
      # --------------------------------------------------
      - name: Update manifest.json
        run: |
          jq '.version = "${{ steps.new.outputs.version }}"' \
            custom_components/trv_regulator/manifest.json > tmp.json

          mv tmp.json custom_components/trv_regulator/manifest.json

      # --------------------------------------------------
      # 6) Update CHANGELOG
      # --------------------------------------------------
      - name: Update CHANGELOG
        run: |
          DATETIME=$(date +"%Y-%m-%d %H:%M")

          if ! grep -q "## \[Unreleased\]" CHANGELOG.md; then
            echo "❌ CHANGELOG.md neobsahuje sekci [Unreleased]!"
            exit 1
          fi

          sed -i "s/## \[Unreleased\]/## [${{ steps.new.outputs.version }}] - $DATETIME\n\n## [Unreleased]/" CHANGELOG.md


      # --------------------------------------------------
      # 7) Urci prerelease logiku
      # --------------------------------------------------
      - name: Determine prerelease
        id: pre
        run: |
          if [ "${{ steps.bump.outputs.type }}" = "patch" ]; then
            echo "pre=false" >> "$GITHUB_OUTPUT"
          else
            echo "pre=true" >> "$GITHUB_OUTPUT"
          fi

      # --------------------------------------------------
      # 8) Commit a tag
      # --------------------------------------------------
      - name: Commit and tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add custom_components/trv_regulator/manifest.json CHANGELOG.md

          git commit -m "chore: bump version to ${{ steps.new.outputs.version }}"

          # Smazat tag pokud už existuje (lokálně i na remote)
          if git rev-parse "v${{ steps.new.outputs.version }}" >/dev/null 2>&1; then
            echo "⚠️ Tag v${{ steps.new.outputs. version }} už existuje, mažu..."
            git tag -d "v${{ steps.new.outputs.version }}"
            git push --delete origin "v${{ steps.new.outputs.version }}" 2>/dev/null || true
          fi

          git tag "v${{ steps.new.outputs.version }}"

          # ochrana proti race condition
          git pull --rebase origin main

          git push origin main --tags

      # --------------------------------------------------
      # 9) Vytvoreni release
      # --------------------------------------------------
      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.new.outputs.version }}
          release_name: Release v${{ steps.new.outputs.version }}
          body: |
            ## Změny z PR

            ${{ github.event.pull_request.title }}

            **PR:** ${{ github.event.pull_request.html_url }}

            ---
            Automaticky vygenerováno.
          draft: false
          prerelease: ${{ steps.pre.outputs.pre }}
